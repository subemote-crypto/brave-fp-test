<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Brave Fingerprint Single Verifier</title>
    <style>
        /* 画面全体のフォントを1.5倍に拡大 */
        body { font-family: monospace; padding: 30px; background-color: #f4f4f4; font-size: 1.5em; } 
        h1 { color: #333; font-size: 1.5em; }
        h2 { font-size: 1.2em; }
        button { font-size: 1em; padding: 10px 20px; margin-right: 15px; cursor: pointer; }
        /* 測定結果のプレエリア */
        #output { 
            background-color: #fff; 
            padding: 20px; 
            border: 2px solid #ddd; 
            white-space: pre-wrap; 
            word-break: break-all;
            font-size: 0.9em; /* ログエリアは少し小さめに */
        } 
        .hash-changed { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Brave Fingerprint 値の単発測定</h1>
    <p>セッションごとに値を測定し、追跡防止機能を確認します。</p>
    
    <button onclick="runTestAndDisplay('Single Measurement')">測定開始 (1回)</button>
    <button onclick="copyResults()">測定結果をコピー</button>
    <hr>
    
    <h2>測定結果ログ</h2>
    <pre id="output">測定ボタンを押してください...</pre>

    <script>
    const log = [];

    // --- 各種フィンガープリント測定関数 (Canvas, Audio, WebGL) ---
    function getCanvasFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 280;
            canvas.height = 40;
            ctx.textBaseline = "top";
            ctx.font = "20px 'Arial'";
            ctx.fillStyle = "#f60";
            ctx.fillRect(100, 1, 80, 20);
            ctx.fillStyle = "#069";
            ctx.fillText("Brave Farbling Test", 2, 25);
            return canvas.toDataURL().slice(-15);
        } catch (e) {
            return "Canvas_Error";
        }
    }

    function getAudioFingerprint() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const analyser = audioCtx.createAnalyser();
            oscillator.connect(analyser);
            oscillator.start(0);
            const buffer = new Float32Array(analyser.frequencyBinCount);
            analyser.getFloatFrequencyData(buffer);
            oscillator.stop(0);
            return buffer.slice(0, 10).reduce((a, b) => a + Math.round(b * 100), 0).toString();
        } catch (e) {
            return "Audio_Error";
        }
    }

    function getWebGLFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return "WebGL_Not_Available";
            
            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            const data = new Uint8Array(4);
            gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, data);
            
            return data.join('_');
        } catch (e) {
            return "WebGL_Error";
        }
    }

    // --- 測定実行と画面表示を行う関数 ---
    function sampleFingerprint() {
        const fp = {};
        
        fp.canvas_hash = getCanvasFingerprint();
        fp.audio_hash = getAudioFingerprint(); 
        fp.webgl_hash = getWebGLFingerprint();
        
        fp.hardwareConcurrency_masked = window.navigator.hardwareConcurrency;
        fp.deviceMemory_masked = window.navigator.deviceMemory;

        fp.ts = (new Date()).toISOString();
        return fp;
    }
    
    function runTestAndDisplay(note) {
        // ログをクリアして新しい測定結果だけを表示
        log.length = 0; 
        
        const fp = sampleFingerprint();
        fp.note = note;
        log.push(fp);
        
        let outputText = "--- 測定結果 ---\n";
        
        log.forEach((entry, index) => {
            outputText += `\n[${index + 1}] ${entry.note}\n`;
            outputText += `  日時: ${entry.ts}\n`;
            outputText += `  Canvas Hash: ${entry.canvas_hash}\n`;
            outputText += `  Audio Hash: ${entry.audio_hash}\n`;
            outputText += `  WebGL Hash: ${entry.webgl_hash}\n`;
            outputText += `  CPU Cores: ${entry.hardwareConcurrency_masked}\n`;
            outputText += `  RAM (GB): ${entry.deviceMemory_masked}\n`;
        });
        
        document.getElementById('output').innerText = outputText;
    }

    // --- コピー機能の関数 ---
    function copyResults() {
        const outputText = document.getElementById('output').innerText;
        
        if (!navigator.clipboard) {
            alert('クリップボードAPIがサポートされていません。テキストを手動でコピーしてください。');
            return;
        }
        
        navigator.clipboard.writeText(outputText)
            .then(() => {
                alert('測定結果をクリップボードにコピーしました！');
            })
            .catch(err => {
                console.error('コピー失敗:', err);
                alert('コピーに失敗しました。');
            });
    }
    </script>

</body>
</html>
