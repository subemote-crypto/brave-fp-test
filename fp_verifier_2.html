<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Brave Farbling Verifier 2</title>
    <style>
        /* â†“â†“â†“ ãƒ«ãƒ¼ãƒˆè¦ç´ ã®ã‚µã‚¤ã‚ºã‚’æ‹¡å¤§ã—ã€ã™ã¹ã¦ã®remã®åŸºæº–ã‚’ç´„24pxã«ã™ã‚‹ â†“â†“â†“ */
        html {
            font-size: 150%; /* é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ16pxã®1.5å€ (24px) */
        }
        
        body {
            font-family: monospace;
            padding: 30px;
            background-color: #f4f4f4;
            font-size: 1rem; /* htmlã®ã‚µã‚¤ã‚º(24px)ã‚’ç¶™æ‰¿ */
        }
        h1 {
            color: #333;
            font-size: 1.4rem; /* 28pxã®ç´„1.2å€ */
        }
        p {
            font-size: 0.9rem; /* 18pxã®ç´„1.2å€ */
        }
        button {
            font-size: 0.75rem; /* 18pxã®ç´„1.2å€ */
            padding: 10px 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        /* æ¸¬å®šçµæœã®ãƒ—ãƒ¬ã‚¨ãƒªã‚¢ */
        #output {
            background-color: #fff;
            padding: 20px;
            border: 2px solid #ddd;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.8rem; /* 16pxã®ç´„1.2å€ */
            
            /* Androidã®Braveã§ã®æ–‡å­—ã®ç•°å¸¸æ‹¡å¤§ã‚’é˜²ãä¿®æ­£ */
            -webkit-text-size-adjust: 100%; 
            text-size-adjust: 100%;        
        }
    </style>
</head>
<body>

    <h1>Brave Farbling Verifier 2 (å·®ç•°æ¤œå‡ºå¼·åŒ–ç‰ˆ)</h1>
    <p>Canvasã¨Audioã®æ¸¬å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶é–“ã®å¾®ç´°ãªå·®ç•°ã‚’æ¤œå‡ºã—ã¾ã™ã€‚</p>

    <button onclick="runTestAndDisplay('Single Measurement')">æ¸¬å®šé–‹å§‹ (1å›)</button>
    <button onclick="copyResults()">æ¸¬å®šçµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    <hr>

    <h2>æ¸¬å®šçµæœãƒ­ã‚°</h2>
    <pre id="output">æ¸¬å®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„...</pre>

    <script>
    const log = [];

    // --- ä¿®æ­£ç‰ˆï¼šCanvas Hash æ¸¬å®šé–¢æ•° ---
    function getCanvasFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; 
            canvas.height = 50; 
            ctx.textBaseline = "top";
            
            // è¤‡é›‘ãªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼šãƒ•ã‚©ãƒ³ãƒˆã¨çµµæ–‡å­—ã‚’æ··ãœã‚‹ (å·®ç•°èª˜ç™º)
            ctx.font = "24px 'Arial', sans-serif"; 
            ctx.fillStyle = "#f60";
            ctx.fillRect(100, 1, 80, 20);
            
            // ã‚·ãƒ£ãƒ‰ã‚¦è¨­å®šã‚’è¿½åŠ  (ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯å‡¦ç†ã®å·®ç•°ã‚’èª˜ç™º)
            ctx.shadowBlur = 4;
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            
            ctx.fillStyle = "#069";
            // çµµæ–‡å­—ã‚’æ··ãœã¦æç”»
            ctx.fillText("Brave Farbling Test ğŸš€", 2, 28); 
            
            // ã‚·ãƒ£ãƒ‰ã‚¦ã‚’ã‚¯ãƒªã‚¢ã—ã¦åˆ¥ã®æç”»
            ctx.shadowBlur = 0; 
            ctx.fillStyle = "#333";
            ctx.font = "16px monospace";
            ctx.fillText("canvas", 5, 5);

            // æç”»çµæœå…¨ä½“ã‚’ãƒãƒƒã‚·ãƒ¥ã¨ã—ã¦ä½¿ç”¨
            return canvas.toDataURL("image/png").slice(-25); 
        } catch (e) {
            return "Canvas_Error";
        }
    }

    // --- ä¿®æ­£ç‰ˆï¼šAudio Hash æ¸¬å®šé–¢æ•° ---
    function getAudioFingerprint() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
            const oscillator = audioCtx.createOscillator();
            const analyser = audioCtx.createAnalyser();
            
            // è¨­å®šã‚’ç´°ã‹ãèª¿æ•´
            analyser.fftSize = 2048; 
            analyser.smoothingTimeConstant = 0.5;

            oscillator.connect(analyser);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
            
            // éŸ³å£°ã‚’çŸ­æ™‚é–“å‡¦ç†ã•ã›ã‚‹
            oscillator.start(0);
            const buffer = new Float32Array(analyser.frequencyBinCount);
            
            // å‡¦ç†æ™‚é–“ã‚’è¨­ã‘ã‚‹ãŸã‚ã€å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            analyser.getFloatFrequencyData(buffer);
            oscillator.stop(0);
            
            // å°æ•°ç‚¹ä»¥ä¸‹ã®å·®ç•°ã‚’æ‹¾ã†ã‚ˆã†ã«é›†è¨ˆæ–¹æ³•ã‚’å¤‰æ›´ (ä¸¸ã‚è¾¼ã¿ã‚’å›é¿)
            const sum = buffer.slice(0, 50).reduce((a, b) => a + b, 0); 
            
            // çµæœã‚’toFixed(12)ã§å°æ•°ç‚¹ä»¥ä¸‹ã¾ã§å«ã‚ã¦æ–‡å­—åˆ—åŒ–ã—ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯æ€§ã‚’é«˜ã‚ã‚‹
            return sum.toFixed(12); 
        } catch (e) {
            return "Audio_Error";
        }
    }
    
    // --- WebGL Hash æ¸¬å®šé–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
    function getWebGLFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return "WebGL_Not_Available";
            
            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            const data = new Uint8Array(4);
            gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, data);
            
            return data.join('_');
        } catch (e) {
            return "WebGL_Error";
        }
    }

    // --- æ¸¬å®šå®Ÿè¡Œã¨ç”»é¢è¡¨ç¤ºã‚’è¡Œã†é–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
    function sampleFingerprint() {
        const fp = {};
        
        fp.canvas_hash = getCanvasFingerprint();
        fp.audio_hash = getAudioFingerprint(); 
        fp.webgl_hash = getWebGLFingerprint();
        
        // ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æƒ…å ±ã®å–å¾—ã¯å¤‰æ›´ãªã—
        fp.hardwareConcurrency_masked = window.navigator.hardwareConcurrency;
        fp.deviceMemory_masked = window.navigator.deviceMemory;

        fp.ts = (new Date()).toISOString();
        return fp;
    }
    
    function runTestAndDisplay(note) {
        log.length = 0; 
        
        const fp = sampleFingerprint();
        fp.note = note;
        log.push(fp);
        
        let outputText = `--- ${document.title} ---`;
        
        log.forEach((entry, index) => {
            outputText += `\n\n[${index + 1}] ${entry.note}\n`;
            outputText += `Â  æ—¥æ™‚: ${entry.ts}\n`;
            outputText += `Â  Canvas Hash: ${entry.canvas_hash}\n`;
            outputText += `Â  Audio Hash: ${entry.audio_hash}\n`;
            outputText += `Â  WebGL Hash: ${entry.webgl_hash}\n`;
            outputText += `Â  CPU Cores: ${entry.hardwareConcurrency_masked}\n`;
            outputText += `Â  RAM (GB): ${entry.deviceMemory_masked}\n`;
        });
        
        document.getElementById('output').innerText = outputText;
    }

    // --- ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®é–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
    function copyResults() {
        const outputText = document.getElementById('output').innerText;
        
        if (!navigator.clipboard) {
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        navigator.clipboard.writeText(outputText)
            .then(() => {
                alert('æ¸¬å®šçµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            })
            .catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
    }
    </script>

</body>
</html>
